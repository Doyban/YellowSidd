var quintusTMX=function(e){"use strict";e.TMX=function(e){function t(e,t){var r=e.getAttribute(t);return isNaN(r)?r:+r}function r(e){for(var r=e.querySelectorAll("property"),s={},i=0;i<r.length;i++){var a=r[i];s[t(a,"name")]=t(a,"value")}return s}e.assetTypes.tmx="TMX",e.loadAssetTMX=function(t,r,s,i){e.loadAssetOther(t,r,function(e,t){var r=new DOMParser,i=r.parseFromString(t,"application/xml");s(e,i)},i)},e._tmxExtractAssetName=function(e){var t=e.getAttribute("source"),r=t.split("/");return r[r.length-1]},e._tmxExtractSources=function(t){var r=t.querySelectorAll("[source]");return e._map(r,e._tmxExtractAssetName)},e.loadTMX=function(t,r,s){e._isString(t)&&(t=e._normalizeArg(t));var i=[];e._each(t,function(t){"tmx"===e._fileExtension(t)&&i.push(t)});var a=[];e.load(t,function(){e._each(i,function(t){var r=e._tmxExtractSources(e.asset(t));a=a.concat(r)}),a.length>0?e.load(a,r,s):r()})},e._tmxLoadTilesets=function(s,i){function a(e){var t=e.split(",");return[parseFloat(t[0]),parseFloat(t[1])]}for(var n=[],o=0;o<s.length;o++){for(var l=s[o],c=t(l,"name"),u=t(l,"firstgid"),m=e._tmxExtractAssetName(l.querySelector("image")),f={},p={tileW:t(l,"tilewidth"),tileH:t(l,"tileheight"),spacingX:t(l,"spacing"),spacingY:t(l,"spacing")},g=l.querySelectorAll("tile"),x=0;x<g.length;x++){var _=g[x],v=t(_,"id"),h=u+v,d=r(_);d.points&&(d.points=e._map(d.points.split(" "),a)),i[h]=d,f[v]=d}p.frameProperties=f,n.push([u,c]),e.sheet(c,m,p)}return n},e._tmxProcessImageLayer=function(t,s,i,a){var n=e._tmxExtractAssetName(a.querySelector("image")),o=r(a);o.asset=n,t.insert(new e.Repeater(o))},e._lookupGid=function(e,t){for(var r=0;t[r+1]&&e>=t[r+1][0];)r++;return t[r]},e._tmxProcessTileLayer=function(s,i,a,n){for(var o,l,c,u=n.querySelectorAll("tile"),m=t(n,"width"),f=t(n,"height"),p=[],g=0,x=0;f>x;x++){p[x]=[];for(var _=0;m>_;_++){var v=t(u[g],"gid");0===v?p[x].push(null):(l||(o=e._lookupGid(t(u[g],"gid"),i),l=o[0],c=o[1]),p[x].push(v-l)),g++}}var h=e._extend({tileW:e.sheet(c).tileW,tileH:e.sheet(c).tileH,sheet:c,tiles:p},r(n)),d=h.Class||"TileLayer";h.collision?s.collisionLayer(new e[d](h)):s.insert(new e[d](h))},e._tmxProcessObjectLayer=function(s,i,a,n){for(var o=n.querySelectorAll("object"),l=0;l<o.length;l++){var c=o[l],u=t(c,"gid"),m=t(c,"x"),f=t(c,"y"),p=a[u],g=r(c);if(!p)throw"Invalid TMX Object: missing properties for GID:"+u;if(!p.Class)throw"Invalid TMX Object: missing Class for GID:"+u;var x=p.Class;if(!x)throw"Invalid TMX Object Class: "+x+" GID:"+u;var _=e._extend(e._extend({x:m,y:f},p),g),v=new e[x](_);v.p.x+=v.p.w/2,v.p.y-=v.p.h/2,s.insert(v)}},e._tmxProcessors={objectgroup:e._tmxProcessObjectLayer,layer:e._tmxProcessTileLayer,imagelayer:e._tmxProcessImageLayer},e.stageTMX=function(t,r){var s=e._isString(t)?e.asset(t):t,i={},a=s.getElementsByTagName("tileset"),n=e._tmxLoadTilesets(a,i);e._each(s.documentElement.childNodes,function(t){var s=t.tagName;e._tmxProcessors[s]&&e._tmxProcessors[s](r,n,i,t)})}}};"undefined"==typeof Quintus?module.exports=quintusTMX:quintusTMX(Quintus);