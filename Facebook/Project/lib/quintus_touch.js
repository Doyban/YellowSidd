var quintusTouch=function(t){"use strict";t.Touch=function(e){if(e._isUndefined(t.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var o=[0],i=0;e.Evented.extend("TouchSystem",{init:function(){var t=this;this.boundTouch=function(e){t.touch(e)},this.boundDrag=function(e){t.drag(e)},this.boundEnd=function(e){t.touchEnd(e)},e.el.addEventListener("touchstart",this.boundTouch),e.el.addEventListener("mousedown",this.boundTouch),e.el.addEventListener("touchmove",this.boundDrag),e.el.addEventListener("mousemove",this.boundDrag),e.el.addEventListener("touchend",this.boundEnd),e.el.addEventListener("mouseup",this.boundEnd),e.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new e.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){e.el.removeEventListener("touchstart",this.boundTouch),e.el.removeEventListener("mousedown",this.boundTouch),e.el.removeEventListener("touchmove",this.boundDrag),e.el.removeEventListener("mousemove",this.boundDrag),e.el.removeEventListener("touchend",this.boundEnd),e.el.removeEventListener("mouseup",this.boundEnd),e.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(t,o){var i=e.el,n=i.getBoundingClientRect(),s=window.getComputedStyle(i),u=t.clientX-n.left-parseInt(s.paddingLeft,10),h=t.clientY-n.top-parseInt(s.paddingTop,10);if((e._isUndefined(u)||e._isUndefined(h))&&(u=t.offsetX,h=t.offsetY),(e._isUndefined(u)||e._isUndefined(h))&&(u=t.layerX,h=t.layerY),e._isUndefined(u)||e._isUndefined(h)){if(void 0===e.touch.offsetX){e.touch.offsetX=0,e.touch.offsetY=0,i=e.el;do e.touch.offsetX+=i.offsetLeft,e.touch.offsetY+=i.offsetTop;while(i=i.offsetParent)}u=t.pageX-e.touch.offsetX,h=t.pageY-e.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=u/e.cssWidth*e.width,this.touchPos.p.oy=this.touchPos.p.py=h/e.cssHeight*e.height,o.viewport&&(this.touchPos.p.px/=o.viewport.scale,this.touchPos.p.py/=o.viewport.scale,this.touchPos.p.px+=o.viewport.x,this.touchPos.p.py+=o.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(t){for(var n=t.changedTouches||[t],s=0;s<n.length;s++)for(var u=0;u<o.length;u++){var h=n[s],c=e.stage(o[u]);if(c){var d=h.identifier||0,r=this.normalizeTouch(h,c);c.regrid(r,!0);var f,a=c.search(r,i);if((a||u===o.length-1)&&(f=a&&a.obj,r.obj=f,this.trigger("touch",r)),f&&!this.touchedObjects[f]){this.activeTouches[d]={x:r.p.px,y:r.p.py,origX:f.p.x,origY:f.p.y,sx:r.p.ox,sy:r.p.oy,identifier:d,obj:f,stage:c},this.touchedObjects[f.p.id]=!0,f.trigger("touch",this.activeTouches[d]);break}}}},drag:function(t){for(var e=t.changedTouches||[t],o=0;o<e.length;o++){var i=e[o],n=i.identifier||0,s=this.activeTouches[n],u=s&&s.stage;if(s){var h=this.normalizeTouch(i,u);s.x=h.p.px,s.y=h.p.py,s.dx=h.p.ox-s.sx,s.dy=h.p.oy-s.sy,s.obj.trigger("drag",s)}}t.preventDefault()},touchEnd:function(t){for(var e=t.changedTouches||[t],o=0;o<e.length;o++){var i=e[o],n=i.identifier||0,s=this.activeTouches[n];s&&(s.obj.trigger("touchEnd",s),delete this.touchedObjects[s.obj.p.id],this.activeTouches[n]=null)}t.preventDefault()}}),e.touch=function(t,n){return e.untouch(),i=t||e.SPRITE_UI,o=n||[2,1,0],e._isArray(o)||(o=[o]),e._touch||(e.touchInput=new e.TouchSystem),e},e.untouch=function(){return e.touchInput&&(e.touchInput.destroy(),delete e.touchInput),e}}};"undefined"==typeof Quintus?module.exports=quintusTouch:quintusTouch(Quintus);