var quintus2D=function(t){"use strict";t["2D"]=function(t){t.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=t.width/2,this.centerY=t.height/2,this.scale=1},extend:{follow:function(i,e,s){this.off("poststep",this.viewport,"follow"),this.viewport.directions=e||{x:!0,y:!0},this.viewport.following=i,t._isUndefined(s)&&void 0!==this.lists.TileLayer?this.viewport.boundingBox=t._detect(this.lists.TileLayer,function(t){return t.p.boundingBox?{minX:0,maxX:t.p.w,minY:0,maxY:t.p.h}:null}):this.viewport.boundingBox=s,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(t,i){this.viewport.centerOn(t,i)},moveTo:function(t,i){return this.viewport.moveTo(t,i)}},follow:function(i){var e=t._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,s=t._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[i===!0?"centerOn":"softCenterOn"](e?this.following.p.x-this.offsetX:void 0,s?this.following.p.y-this.offsetY:void 0)},offset:function(t,i){this.offsetX=t,this.offsetY=i},softCenterOn:function(i,e){if(void 0!==i){var s=(i-t.width/2/this.scale-this.x)/3;this.boundingBox?this.x+s<this.boundingBox.minX?this.x=this.boundingBox.minX/this.scale:this.x+s>(this.boundingBox.maxX-t.width)/this.scale?this.x=Math.max(this.boundingBox.maxX-t.width,this.boundingBox.minX)/this.scale:this.x+=s:this.x+=s}if(void 0!==e){var o=(e-t.height/2/this.scale-this.y)/3;this.boundingBox?this.y+o<this.boundingBox.minY?this.y=this.boundingBox.minY/this.scale:this.y+o>(this.boundingBox.maxY-t.height)/this.scale?this.y=Math.max(this.boundingBox.maxY-t.height,this.boundingBox.minY)/this.scale:this.y+=o:this.y+=o}},centerOn:function(i,e){void 0!==i&&(this.x=i-t.width/2/this.scale),void 0!==e&&(this.y=e-t.height/2/this.scale)},moveTo:function(t,i){return void 0!==t&&(this.x=t),void 0!==i&&(this.y=i),this.entity},prerender:function(){this.centerX=this.x+t.width/2/this.scale,this.centerY=this.y+t.height/2/this.scale,t.ctx.save(),t.ctx.translate(Math.floor(t.width/2),Math.floor(t.height/2)),t.ctx.scale(this.scale,this.scale),t.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){t.ctx.restore()}}),t.Sprite.extend("TileLayer",{init:function(t){this._super(t,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1,renderAlways:!0}),this.p.dataAsset&&this.load(this.p.dataAsset),this.setDimensions(),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.tileProperties={},this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.tileCollisionObjects={},this.collisionNormal={separate:[]},this._generateCollisionObjects()},_generateCollisionObjects:function(){function i(t){return[t[0]*e.p.tileW-e.p.tileW/2,t[1]*e.p.tileH-e.p.tileH/2]}var e=this;if(this.sheet()&&this.sheet().frameProperties){var s=this.sheet().frameProperties;for(var o in s){var n=this.tileCollisionObjects[o]={p:t._clone(this.collisionObject.p)};t._extend(n.p,s[o]),n.p.points&&(n.p.points=t._map(n.p.points,i)),this.tileCollisionObjects[o]=n}}},load:function(i){var e,s=i.split("."),o=s[s.length-1].toLowerCase();if("json"!==o)throw"file type not supported";e=t._isString(i)?t.asset(i):i,this.p.tiles=e},setDimensions:function(){var t=this.p.tiles;t&&(this.p.rows=t.length,this.p.cols=t[0].length,this.p.w=this.p.cols*this.p.tileW,this.p.h=this.p.rows*this.p.tileH)},getTile:function(t,i){return this.p.tiles[i]&&this.p.tiles[i][t]},getTileProperty:function(t,i){return void 0!==this.tileProperties[t]?this.tileProperties[t][i]:void 0},getTileProperties:function(t){return void 0!==this.tileProperties[t]?this.tileProperties[t]:{}},getTilePropertyAt:function(t,i,e){return this.getTileProperty(this.getTile(t,i),e)},getTilePropertiesAt:function(t,i){return this.getTileProperties(this.getTile(t,i))},tileHasProperty:function(t,i){return void 0!==this.getTileProperty(t,i)},setTile:function(t,i,e){var s=this.p,o=Math.floor(t/s.blockTileW),n=Math.floor(i/s.blockTileH);t>=0&&t<this.p.cols&&i>=0&&i<this.p.rows&&(this.p.tiles[i][t]=e,this.blocks[n]&&(this.blocks[n][o]=null))},tilePresent:function(t,i){return this.p.tiles[i]&&this.collidableTile(this.p.tiles[i][t])},drawableTile:function(t){return t>0},collidableTile:function(t){return t>0},getCollisionObject:function(t,i){var e,s=this.p,o=this.getTile(t,i);return e=void 0!==this.tileCollisionObjects[o]?this.tileCollisionObjects[o]:this.collisionObject,e.p.x=t*s.tileW+s.x+s.tileW/2,e.p.y=i*s.tileH+s.y+s.tileH/2,e},collide:function(i){var e,s,o=this.p,n=i.c||i.p,l=Math.floor((n.x-n.cx-o.x)/o.tileW),h=Math.floor((n.y-n.cy-o.y)/o.tileH),r=Math.ceil((n.x-n.cx+n.w-o.x)/o.tileW),c=Math.ceil((n.y-n.cy+n.h-o.y)/o.tileH),a=this.collisionNormal;a.collided=!1;for(var p=h;c>=p;p++)for(var f=l;r>=f;f++)this.tilePresent(f,p)&&(s=this.getCollisionObject(f,p),e=t.collision(i,s),e&&e.magnitude>0&&(s.p.sensor?(s.tile=this.getTile(f,p),i.trigger&&i.trigger("sensor.tile",s)):(!a.collided||a.magnitude<e.magnitude)&&(a.collided=!0,a.separate[0]=e.separate[0],a.separate[1]=e.separate[1],a.magnitude=e.magnitude,a.distance=e.distance,a.normalX=e.normalX,a.normalY=e.normalY,a.tileX=f,a.tileY=p,a.tile=this.getTile(f,p),void 0!==i.p.collisions&&i.p.collisions.push(a))));return a.collided?a:!1},prerenderBlock:function(t,i){var e=this.p,s=e.tiles,o=this.sheet(),n=t*e.blockTileW,l=i*e.blockTileH;if(!(0>n||n>=this.p.cols||0>l||l>=this.p.rows)){var h=document.createElement("canvas"),r=h.getContext("2d");h.width=e.blockW,h.height=e.blockH,this.blocks[i]=this.blocks[i]||{},this.blocks[i][t]=h;for(var c=0;c<e.blockTileH;c++)if(s[c+l])for(var a=0;a<e.blockTileW;a++)this.drawableTile(s[c+l][a+n])&&o.draw(r,a*e.tileW,c*e.tileH,s[c+l][a+n])}},drawBlock:function(t,i,e){var s=this.p,o=Math.floor(i*s.blockW+s.x),n=Math.floor(e*s.blockH+s.y);this.blocks[e]&&this.blocks[e][i]||this.prerenderBlock(i,e),this.blocks[e]&&this.blocks[e][i]&&t.drawImage(this.blocks[e][i],o,n)},draw:function(i){for(var e=this.p,s=this.stage.viewport,o=s?s.scale:1,n=s?s.x:0,l=s?s.y:0,h=t.width/o,r=t.height/o,c=Math.floor((n-e.x)/e.blockW),a=Math.floor((l-e.y)/e.blockH),p=Math.floor((n+h-e.x)/e.blockW),f=Math.floor((l+r-e.y)/e.blockH),d=a;f>=d;d++)for(var u=c;p>=u;u++)this.drawBlock(i,u,d)}}),t.gravityY=9.8*100,t.gravityX=0,t.component("2d",{added:function(){var i=this.entity;t._defaults(i.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:t.SPRITE_DEFAULT}),i.on("step",this,"step"),i.on("hit",this,"collision")},collision:function(t,i){var e=this.entity,s=e.p;if(t.obj.p&&t.obj.p.sensor)return void t.obj.trigger("sensor",e);t.impact=0;var o=Math.abs(s.vx),n=Math.abs(s.vy);s.x-=t.separate[0],s.y-=t.separate[1],t.normalY<-.3&&(!s.skipCollide&&s.vy>0&&(s.vy=0),t.impact=n,e.trigger("bump.bottom",t),e.trigger("bump",t)),t.normalY>.3&&(!s.skipCollide&&s.vy<0&&(s.vy=0),t.impact=n,e.trigger("bump.top",t),e.trigger("bump",t)),t.normalX<-.3&&(!s.skipCollide&&s.vx>0&&(s.vx=0),t.impact=o,e.trigger("bump.right",t),e.trigger("bump",t)),t.normalX>.3&&(!s.skipCollide&&s.vx<0&&(s.vx=0),t.impact=o,e.trigger("bump.left",t),e.trigger("bump",t))},step:function(i){for(var e=this.entity.p,s=i;s>0;)i=Math.min(1/30,s),e.vx+=e.ax*i+(void 0===e.gravityX?t.gravityX:e.gravityX)*i*e.gravity,e.vy+=e.ay*i+(void 0===e.gravityY?t.gravityY:e.gravityY)*i*e.gravity,e.x+=e.vx*i,e.y+=e.vy*i,this.entity.stage.collide(this.entity),s-=i}}),t.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(t){this.entity.p.vx=-t.impact,"right"===this.entity.p.defaultDirection?this.entity.p.flip="x":this.entity.p.flip=!1},goRight:function(t){this.entity.p.vx=t.impact,"left"===this.entity.p.defaultDirection?this.entity.p.flip="x":this.entity.p.flip=!1}})}};"undefined"==typeof Quintus?module.exports=quintus2D:quintus2D(Quintus);