var quintusSprites=function(t){"use strict";t.Sprites=function(t){return t.Class.extend("SpriteSheet",{init:function(i,s,e){if(!t.asset(s))throw"Invalid Asset:"+s;t._extend(this,{name:i,asset:s,w:t.asset(s).width,h:t.asset(s).height,tileW:64,tileH:64,sx:0,sy:0,spacingX:0,spacingY:0,frameProperties:{}}),e&&t._extend(this,e),this.tilew&&(this.tileW=this.tilew,delete this.tilew),this.tileh&&(this.tileH=this.tileh,delete this.tileh),this.cols=this.cols||Math.floor((this.w+this.spacingX)/(this.tileW+this.spacingX)),this.frames=this.cols*Math.floor(this.h/(this.tileH+this.spacingY))},fx:function(t){return Math.floor(t%this.cols*(this.tileW+this.spacingX)+this.sx)},fy:function(t){return Math.floor(Math.floor(t/this.cols)*(this.tileH+this.spacingY)+this.sy)},draw:function(i,s,e,h){i||(i=t.ctx),i.drawImage(t.asset(this.asset),this.fx(h),this.fy(h),this.tileW,this.tileH,Math.floor(s),Math.floor(e),this.tileW,this.tileH)}}),t.sheets={},t.sheet=function(i,s,e){return s?void(t.sheets[i]=new t.SpriteSheet(i,s,e)):t.sheets[i]},t.compileSheets=function(i,s){var e=t.asset(s);t._each(e,function(s,e){t.sheet(e,i,s)})},t.SPRITE_NONE=0,t.SPRITE_DEFAULT=1,t.SPRITE_PARTICLE=2,t.SPRITE_ACTIVE=4,t.SPRITE_FRIENDLY=8,t.SPRITE_ENEMY=16,t.SPRITE_POWERUP=32,t.SPRITE_UI=64,t.SPRITE_ALL=65535,t._generatePoints=function(t,i){if(!t.p.points||i){var s=t.p,e=s.w/2,h=s.h/2;s.points=[[-e,-h],[e,-h],[e,h],[-e,h]]}},t._generateCollisionPoints=function(i){if(i.matrix||i.refreshMatrix){i.c||(i.c={points:[]});var s=i.p,e=i.c;if(s.moved||e.origX!==s.x||e.origY!==s.y||e.origScale!==s.scale||e.origAngle!==s.angle){e.origX=s.x,e.origY=s.y,e.origScale=s.scale,e.origAngle=s.angle,i.refreshMatrix();var h;if(i.container||s.scale&&1!==s.scale||0!==s.angle){var n=i.container||t._nullContainer;e.x=n.matrix.transformX(s.x,s.y),e.y=n.matrix.transformY(s.x,s.y),e.angle=s.angle+n.c.angle,e.scale=(n.c.scale||1)*(s.scale||1);var r=1/0,o=1/0,a=-(1/0),p=-(1/0);for(h=0;h<i.p.points.length;h++){i.c.points[h]||(i.c.points[h]=[]),i.matrix.transformArr(i.p.points[h],i.c.points[h]);var l=i.c.points[h][0],c=i.c.points[h][1];r>l&&(r=l),l>a&&(a=l),o>c&&(o=c),c>p&&(p=c)}r===a&&(a+=1),o===p&&(p+=1),e.cx=e.x-r,e.cy=e.y-o,e.w=a-r,e.h=p-o}else{for(h=0;h<i.p.points.length;h++)i.c.points[h]=i.c.points[h]||[],i.c.points[h][0]=s.x+i.p.points[h][0],i.c.points[h][1]=s.y+i.p.points[h][1];e.x=s.x,e.y=s.y,e.cx=s.cx,e.cy=s.cy,e.w=s.w,e.h=s.h}s.moved=!1,i.children&&i.children.length>0&&t._invoke(i.children,"moved")}}},t.GameObject.extend("Sprite",{init:function(i,s){this.p=t._extend({x:0,y:0,z:0,opacity:1,angle:0,frame:0,type:t.SPRITE_DEFAULT|t.SPRITE_ACTIVE,name:"",spriteProperties:{}},s),this.matrix=new t.Matrix2D,this.children=[],t._extend(this.p,i),this.size(),this.p.id=this.p.id||t._uniqueId(),this.refreshMatrix()},size:function(t){!t&&this.p.w&&this.p.h||(this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tileW,this.p.h=this.sheet().tileH)),this.p.cx=t||void 0===this.p.cx?this.p.w/2:this.p.cx,this.p.cy=t||void 0===this.p.cy?this.p.h/2:this.p.cy},asset:function(i,s){return i?(this.p.asset=i,void(s&&(this.size(!0),t._generatePoints(this,!0)))):t.asset(this.p.asset)},sheet:function(i,s){return i?(this.p.sheet=i,void(s&&(this.size(!0),t._generatePoints(this,!0)))):t.sheet(this.p.sheet)},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(i){return t._extend(this.p,i),this},_sortChild:function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)},_flipArgs:{x:[-1,1],y:[1,-1],xy:[-1,-1]},render:function(i){var s=this.p;s.hidden||0===s.opacity||(i||(i=t.ctx),this.trigger("predraw",i),i.save(),void 0!==this.p.opacity&&1!==this.p.opacity&&(i.globalAlpha=this.p.opacity),this.matrix.setContextTransform(i),this.p.flip&&i.scale.apply(i,this._flipArgs[this.p.flip]),this.trigger("beforedraw",i),this.draw(i),this.trigger("draw",i),i.restore(),this.p.sort&&this.children.sort(this._sortChild),t._invoke(this.children,"render",i),this.trigger("postdraw",i),t.debug&&this.debugRender(i))},center:function(){this.container?(this.p.x=0,this.p.y=0):(this.p.x=t.width/2,this.p.y=t.height/2)},draw:function(i){var s=this.p;s.sheet?this.sheet().draw(i,-s.cx,-s.cy,s.frame):s.asset?i.drawImage(t.asset(s.asset),-s.cx,-s.cy):s.color&&(i.fillStyle=s.color,i.fillRect(-s.cx,-s.cy,s.w,s.h))},debugRender:function(i){this.p.points||t._generatePoints(this),i.save(),this.matrix.setContextTransform(i),i.beginPath(),i.fillStyle=this.p.hit?"blue":"red",i.strokeStyle="#FF0000",i.fillStyle="rgba(0,0,0,0.5)",i.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var s=0;s<this.p.points.length;s++)i.lineTo(this.p.points[s][0],this.p.points[s][1]);if(i.lineTo(this.p.points[0][0],this.p.points[0][1]),i.stroke(),t.debugFill&&i.fill(),i.restore(),this.c){var e=this.c;i.save(),i.globalAlpha=1,i.lineWidth=2,i.strokeStyle="#FF00FF",i.beginPath(),i.moveTo(e.x-e.cx,e.y-e.cy),i.lineTo(e.x-e.cx+e.w,e.y-e.cy),i.lineTo(e.x-e.cx+e.w,e.y-e.cy+e.h),i.lineTo(e.x-e.cx,e.y-e.cy+e.h),i.lineTo(e.x-e.cx,e.y-e.cy),i.stroke(),i.restore()}},update:function(i){this.trigger("prestep",i),this.step&&this.step(i),this.trigger("step",i),t._generateCollisionPoints(this),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,i,!0),this.p.collisions&&(this.p.collisions=[])},refreshMatrix:function(){var t=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(t.x,t.y),t.scale&&this.matrix.scale(t.scale,t.scale),this.matrix.rotateDeg(t.angle)},moved:function(){this.p.moved=!0}}),t.Sprite.extend("MovingSprite",{init:function(i,s){this._super(t._extend({vx:0,vy:0,ax:0,ay:0},i),s)},step:function(t){var i=this.p;i.vx+=i.ax*t,i.vy+=i.ay*t,i.x+=i.vx*t,i.y+=i.vy*t}}),t}};"undefined"==typeof Quintus?module.exports=quintusSprites:quintusSprites(Quintus);