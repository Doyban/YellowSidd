var quintusScenes=function(t){"use strict";t.Scenes=function(t){t.scenes={},t.stages=[],t.Class.extend("Scene",{init:function(t,i){this.opts=i||{},this.sceneFunc=t}}),t.scene=function(i,e,s){return void 0===e?t.scenes[i]:(t._isFunction(e)&&(e=new t.Scene(e,s),e.name=i),t.scenes[i]=e,e)},t._nullContainer={c:{x:0,y:0,angle:0,scale:1},matrix:t.matrix2d()},t.collision=function(){function i(t,i){var e=t[i],s=t[i+1]||t[0];r=-(s[1]-e[1]),o=s[0]-e[0];var n=Math.sqrt(r*r+o*o);n>0&&(r/=n,o/=n)}function e(t){return r*t[0]+o*t[1]}function s(t,s,n){var g,l,d,u,f,p,m,v,_,y,x,L,S,C,b=Number.POSITIVE_INFINITY,k=!1,j=n?c:h;for(a[0]=0,a[1]=0,t.c?S=t.c.points:(S=t.p.points,a[0]+=t.p.x,a[1]+=t.p.y),s.c?C=s.c.points:(C=s.p.points,a[0]+=-s.p.x,a[1]+=-s.p.y),t=t.p,s=s.p,_=0;_<S.length;_++){for(i(S,_),g=e(S[0]),l=g,y=1;y<S.length;y++)v=e(S[y]),g>v&&(g=v),v>l&&(l=v);for(d=e(C[0]),u=d,y=1;y<C.length;y++)v=e(C[y]),d>v&&(d=v),v>u&&(u=v);if(m=e(a),g+=m,l+=m,f=g-u,p=d-l,f>0||p>0)return null;x=-1*(u-g),n&&(x*=-1),L=Math.abs(x),b>L&&(j.distance=x,j.magnitude=L,j.normalX=r,j.normalY=o,j.distance>0&&(j.distance*=-1,j.normalX*=-1,j.normalY*=-1),k=!0,b=L)}return k?j:null}function n(i,e){var n,r,o;return i.p.points||t._generatePoints(i),e.p.points||t._generatePoints(e),(n=s(i,e))&&(r=s(e,i,!0))?(o=r.magnitude<n.magnitude?r:n,0===o.magnitude?!1:(o.separate[0]=o.distance*o.normalX,o.separate[1]=o.distance*o.normalY,o)):!1}var r,o,a=[0,0],h={separate:[]},c={separate:[]};return n}(),t.overlap=function(t,i){var e=t.c||t.p||t,s=i.c||i.p||i,n=e.x-(e.cx||0),r=e.y-(e.cy||0),o=s.x-(s.cx||0),a=s.y-(s.cy||0);return!(r+e.h<a||r>a+s.h||n+e.w<o||n>o+s.w)},t.Stage=t.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400,x:0,y:0},init:function(i,e){this.scene=i,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this._collisionLayers=[],this.time=0,this.defaults.w=t.width,this.defaults.h=t.height,this.options=t._extend({},this.defaults),this.scene&&t._extend(this.options,i.opts),e&&t._extend(this.options,e),this.options.sort&&!t._isFunction(this.options.sort)&&(this.options.sort=function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},loadAssets:function(i){for(var e=t._isArray(i)?i:t.asset(i),s=0;s<e.length;s++){var n=e[s][0],r=e[s][1];this.insert(new t[n](r))}},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2])},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2])},detect:function(t){for(var i=this.items.length-1;i>=0;i--)if(t.call(this.items[i],arguments[1],arguments[2],arguments[3]))return this.items[i];return!1},identify:function(t){for(var i,e=this.items.length-1;e>=0;e--)if(i=t.call(this.items[e],arguments[1],arguments[2],arguments[3]))return i;return!1},find:function(t){return this.index[t]},addToLists:function(t,i){for(var e=0;e<t.length;e++)this.addToList(t[e],i)},addToList:function(t,i){this.lists[t]||(this.lists[t]=[]),this.lists[t].push(i)},removeFromLists:function(t,i){for(var e=0;e<t.length;e++)this.removeFromList(t[e],i)},removeFromList:function(t,i){var e=this.lists[t].indexOf(i);-1!==e&&this.lists[t].splice(e,1)},insert:function(i,e){return this.items.push(i),i.stage=this,i.container=e,e&&e.children.push(i),i.grid={},t._generatePoints(i),t._generateCollisionPoints(i),i.className&&this.addToList(i.className,i),i.activeComponents&&this.addToLists(i.activeComponents,i),i.p&&(this.index[i.p.id]=i),this.trigger("inserted",i),i.trigger("inserted",this),this.regrid(i),i},remove:function(t){this.delGrid(t),this.removeList.push(t)},forceRemove:function(t){var i=this.items.indexOf(t);if(-1!==i){if(this.items.splice(i,1),t.className&&this.removeFromList(t.className,t),t.activeComponents&&this.removeFromLists(t.activeComponents,t),t.container){var e=t.container.children.indexOf(t);-1!==e&&t.container.children.splice(e,1)}t.destroy&&t.destroy(),t.p.id&&delete this.index[t.p.id],this.trigger("removed",t)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(i,e,s,n){if(t._isUndefined(n)||n&i){var r=this.index[e];if(r&&r!==s&&t.overlap(s,r)){var o=t.collision(s,r);return o?(o.obj=r,o):!1}}},gridTest:function(i,e){for(var s,n,r=i.grid,o=r.Y1;o<=r.Y2;o++)if(this.grid[o])for(var a=r.X1;a<=r.X2;a++)if(s=this.grid[o][a],s&&(n=t._detect(s,this._gridCellCheck,this,i,e)))return n;return!1},collisionLayer:function(t){return this._collisionLayers.push(t),t.collisionLayer=!0,this.insert(t)},_collideCollisionLayer:function(t,i){for(var e,s=0,n=this._collisionLayers.length;n>s;s++){var r=this._collisionLayers[s];if(r.p.type&i&&(e=r.collide(t)))return e.obj=r,e}return!1},search:function(i,e){var s;return i.grid||this.regrid(i,i.stage!==this),e=t._isUndefined(e)?i.p&&i.p.collisionMask:e,s=this._collideCollisionLayer(i,e),s=s||this.gridTest(i,e)},_locateObj:{p:{x:0,y:0,cx:0,cy:0,w:1,h:1},grid:{}},locate:function(t,i,e){var s=null;return this._locateObj.p.x=t,this._locateObj.p.y=i,this.regrid(this._locateObj,!0),s=this._collideCollisionLayer(this._locateObj,e),s=s||this.gridTest(this._locateObj,e),s&&s.obj?s.obj:!1},collide:function(i,e){var s,n,r,o,a,h;for(t._isObject(e)?(r=e.collisionMask,o=e.maxCol,h=e.skipEvents):r=e,r=t._isUndefined(r)?i.p&&i.p.collisionMask:r,o=o||3,t._generateCollisionPoints(i),this.regrid(i),a=o;a>0&&(s=this._collideCollisionLayer(i,r));)h||(i.trigger("hit",s),i.trigger("hit.collision",s)),t._generateCollisionPoints(i),this.regrid(i),a--;for(a=o;a>0&&(n=this.gridTest(i,r));){if(i.trigger("hit",n),i.trigger("hit.sprite",n),!h){var c=n.obj;n.obj=i,n.normalX*=-1,n.normalY*=-1,n.distance=0,n.magnitude=0,n.separate[0]=0,n.separate[1]=0,c.trigger("hit",n),c.trigger("hit.sprite",n)}t._generateCollisionPoints(i),this.regrid(i),a--}return n||s},delGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++)if(this.grid[e])for(var s=i.X1;s<=i.X2;s++)this.grid[e][s]&&delete this.grid[e][s][t.p.id]},addGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++){this.grid[e]||(this.grid[e]={});for(var s=i.X1;s<=i.X2;s++)this.grid[e][s]||(this.grid[e][s]={}),this.grid[e][s][t.p.id]=t.p.type}},regrid:function(t,i){if(!t.collisionLayer){t.grid=t.grid||{};var e=t.c||t.p,s=Math.floor((e.x-e.cx)/this.options.gridW),n=Math.floor((e.y-e.cy)/this.options.gridH),r=Math.floor((e.x-e.cx+e.w)/this.options.gridW),o=Math.floor((e.y-e.cy+e.h)/this.options.gridH),a=t.grid;(a.X1!==s||a.X2!==r||a.Y1!==n||a.Y2!==o)&&(void 0!==a.X1&&this.delGrid(t),a.X1=s,a.X2=r,a.Y1=n,a.Y2=o,i||this.addGrid(t))}},markSprites:function(i,e){for(var s,n,r=this.viewport,o=r?r.scale:1,a=r?r.x:0,h=r?r.y:0,c=t.width/o,g=t.height/o,l=Math.floor(a/this.options.gridW),d=Math.floor(h/this.options.gridH),u=Math.floor((a+c)/this.options.gridW),f=Math.floor((h+g)/this.options.gridH),p=d;f>=p;p++)if(s=this.grid[p])for(var m=l;u>=m;m++)if(n=s[m])for(var v in n)this.index[v]&&(this.index[v].mark=e,this.index[v].container&&(this.index[v].container.mark=e))},updateSprites:function(i,e,s){for(var n,r=0,o=i.length;o>r;r++)n=i[r],(s||!n.p.visibleOnly||n.mark&&!(n.mark<this.time))&&(s||!n.container)&&(n.update(e),t._generateCollisionPoints(n),this.regrid(n))},step:function(t){if(this.paused)return!1;if(this.time+=t,this.markSprites(this.items,this.time),this.trigger("prestep",t),this.updateSprites(this.items,t),this.trigger("step",t),this.removeList.length>0){for(var i=0,e=this.removeList.length;e>i;i++)this.forceRemove(this.removeList[i]);this.removeList.length=0}this.trigger("poststep",t)},hide:function(){this.hidden=!0},show:function(){this.hidden=!1},stop:function(){this.hide(),this.pause()},start:function(){this.show(),this.unpause()},render:function(t){if(this.hidden)return!1;this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",t),this.trigger("beforerender",t);for(var i=0,e=this.items.length;e>i;i++){var s=this.items[i];!s.container&&(s.p.renderAlways||s.mark>=this.time)&&s.render(t)}this.trigger("render",t),this.trigger("postrender",t)}}),t.activeStage=0,t.StageSelector=t.Class.extend({emptyList:[],init:function(t,i){this.stage=t,this.selector=i,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2]);return this},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2]);return this},trigger:function(t,i){this.invoke("trigger",t,i)},destroy:function(){this.invoke("destroy")},detect:function(t){for(var i=0,e=this.items.length;e>i;i++)if(t.call(this.items[i],arguments[1],arguments[2]))return this.items[i];return!1},identify:function(t){for(var i=null,e=0,s=this.items.length;s>e;e++)if(i=t.call(this.items[e],arguments[1],arguments[2]))return i;return!1},_pObject:function(i){t._extend(this.p,i)},_pSingle:function(t,i){this.p[t]=i},set:function(t,i){return void 0===i?this.each(this._pObject,t):this.each(this._pSingle,t,i),this},at:function(t){return this.items[t]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),t.select=function(i,e){return e=void 0===e?t.activeStage:e,e=t.stage(e),t._isNumber(i)?e.index[i]:new t.StageSelector(e,i)},t.stage=function(i){return i=void 0===i?t.activeStage:i,t.stages[i]},t.stageScene=function(i,e,s){t._isString(i)&&(i=t.scene(i)),t._isObject(e)&&(s=e,e=t._popProperty(s,"stage")||i&&i.opts.stage||0),s=t._clone(s);var n=t._popProperty(s,"stageClass")||i&&i.opts.stageClass||t.Stage;e=t._isUndefined(e)?i&&i.opts.stage||0:e,t.stages[e]&&t.stages[e].destroy(),t.activeStage=e;var r=t.stages[e]=new n(i,s);return r.options.asset&&r.loadAssets(r.options.asset),i&&r.loadScene(),t.activeStage=0,t.loop||t.gameLoop(t.stageGameLoop),r},t.stageStepLoop=function(i){var e,s,n;for(0>i&&(i=1/60),i>1/15&&(i=1/15),e=0,s=t.stages.length;s>e;e++)t.activeStage=e,n=t.stage(),n&&n.step(i);t.activeStage=0},t.stageRenderLoop=function(){t.ctx&&t.clear();for(var i=0,e=t.stages.length;e>i;i++){t.activeStage=i;var s=t.stage();s&&s.render(t.ctx)}t.input&&t.ctx&&t.input.drawCanvas(t.ctx),t.activeStage=0},t.stageGameLoop=function(i){t.stageStepLoop(i),t.stageRenderLoop()},t.clearStage=function(i){t.stages[i]&&(t.stages[i].destroy(),t.stages[i]=null)},t.clearStages=function(){for(var i=0,e=t.stages.length;e>i;i++)t.stages[i]&&t.stages[i].destroy();t.stages.length=0}}};"undefined"==typeof Quintus?module.exports=quintusScenes:quintusScenes(Quintus);